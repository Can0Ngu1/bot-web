import streamlit as st
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go
from datetime import datetime, timedelta
import json
import os
import threading
import asyncio
import time
from apscheduler.schedulers.background import BackgroundScheduler
import logging
from urllib.parse import quote_plus
import requests
from telegram import Bot
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.chrome.service import Service
from webdriver_manager.chrome import ChromeDriverManager
from bs4 import BeautifulSoup
import io

# === C·∫§U H√åNH STREAMLIT ===
st.set_page_config(
    page_title="üöÄ Bot Theo D√µi G√≥i Th·∫ßu Pro",
    page_icon="üöÄ",
    layout="wide",
    initial_sidebar_state="expanded",
    menu_items={
        'Get Help': 'https://github.com',
        'Report a bug': None,
        'About': "Bot Theo D√µi G√≥i Th·∫ßu Pro 2025 - Enterprise Edition"
    }
)

# === CONSTANTS & CONFIG ===
CONFIG_FILE = "config.json"
DEFAULT_CONFIG = {
    "TELEGRAM_TOKEN": "7413526182:AAHbqSltL84gIp3xL60B2RKtu5_zbXk1C-8",
    "CHAT_ID": -4788707953,
    "CHECK_INTERVAL_MINUTES": 30,
    "AUTO_START": True,
    "WINDOW_GEOMETRY": "1500x1000+100+100"
}
NOTIFIED_FILE = "notified_biddings.json"
BIDDINGS_FILE = "biddings.json"

# === SETUP LOGGING ===
logging.basicConfig(
    format='%(asctime)s - %(levelname)s - %(message)s',
    level=logging.INFO,
    handlers=[
        logging.FileHandler("bot.log", encoding='utf-8'),
        logging.StreamHandler()
    ]
)
logger = logging.getLogger(__name__)

# === BACKEND FUNCTIONS ===
def load_config():
    if os.path.exists(CONFIG_FILE):
        try:
            with open(CONFIG_FILE, 'r', encoding='utf-8') as f:
                return json.load(f)
        except:
            return DEFAULT_CONFIG
    return DEFAULT_CONFIG

def save_config(config):
    try:
        with open(CONFIG_FILE, 'w', encoding='utf-8') as f:
            json.dump(config, f, ensure_ascii=False, indent=2)
    except Exception as e:
        logger.error(f"L·ªói khi l∆∞u c·∫•u h√¨nh: {e}")

def load_notified_biddings():
    if os.path.exists(NOTIFIED_FILE):
        try:
            with open(NOTIFIED_FILE, 'r', encoding='utf-8') as f:
                return set(json.load(f))
        except:
            return set()
    return set()

def save_notified_biddings(notified_set):
    try:
        with open(NOTIFIED_FILE, 'w', encoding='utf-8') as f:
            json.dump(list(notified_set), f, ensure_ascii=False, indent=2)
    except Exception as e:
        logger.error(f"L·ªói khi l∆∞u file notified_biddings: {e}")

def save_biddings(biddings):
    try:
        with open(BIDDINGS_FILE, 'w', encoding='utf-8') as f:
            json.dump(biddings, f, ensure_ascii=False, indent=2)
        logger.info(f"ƒê√£ l∆∞u {len(biddings)} g√≥i th·∫ßu v√†o {BIDDINGS_FILE}")
    except Exception as e:
        logger.error(f"L·ªói khi l∆∞u file biddings: {e}")

def get_chrome_options():
    options = Options()
    options.add_argument("--headless")
    options.add_argument("--disable-gpu")
    options.add_argument("--no-sandbox")
    options.add_argument("--disable-dev-shm-usage")
    options.add_argument("--disable-extensions")
    options.add_argument("--blink-settings=imagesEnabled=false")
    options.add_argument("--window-size=1920,1080")
    options.add_argument(
        "--user-agent=Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"
    )
    return options

def build_bidding_url():
    today = datetime.now().strftime("%d/%m/%Y")
    base_url = "https://dauthau.asia/thongbao/moithau/?"
    params = [
        "q=Chi·∫øu+s√°ng",
        "type_search=1",
        "type_info=1",
        "type_info3=1",
        f"sfrom={quote_plus('05/08/2025')}",
        f"sto={quote_plus(today)}",
        "is_advance=0",
        "is_province=0",
        "is_kqlcnt=0",
        "type_choose_id=0",
        "type_choose_id=0",
        "search_idprovincekq=1",
        "search_idprovince_khtt=1",
        "goods_2=0",
        "searchkind=0",
        "type_view_open=0",
        "sl_nhathau=0",
        "sl_nhathau_cgtt=0",
        "search_idprovince=1",
        "type_org=1",
        "goods=0",
        "cat=0",
        "keyword_id_province=0",
        "oda=-1",
        "khlcnt=0",
        "search_rq_province=-1",
        "search_rq_province=1",
        "rq_form_value=0",
        "searching=1"
    ]
    url = base_url + "&".join(params)
    return url

def check_new_biddings():
    logger.info("B·∫Øt ƒë·∫ßu ki·ªÉm tra g√≥i th·∫ßu m·ªõi...")
    notified = load_notified_biddings()
    logger.info(f"ƒê√£ c√≥ {len(notified)} g√≥i th·∫ßu ƒë∆∞·ª£c th√¥ng b√°o tr∆∞·ªõc ƒë√≥")
    options = get_chrome_options()
    driver = None
    new_biddings = []
    try:
        service = Service(ChromeDriverManager().install())
        driver = webdriver.Chrome(service=service, options=options)
        url = build_bidding_url()
        logger.info("ƒêang truy c·∫≠p trang web...")
        driver.get(url)
        time.sleep(3)
        
        try:
            WebDriverWait(driver, 30).until(
                EC.presence_of_element_located((By.CLASS_NAME, "bidding-code"))
            )
            logger.info("Trang web ƒë√£ load th√†nh c√¥ng, b·∫Øt ƒë·∫ßu thu th·∫≠p d·ªØ li·ªáu...")
        except:
            logger.warning("Kh√¥ng t√¨m th·∫•y element g√≥i th·∫ßu - c√≥ th·ªÉ trang ch∆∞a load xong")
            return []
            
        soup = BeautifulSoup(driver.page_source, "html.parser")
        rows = soup.find_all("tr")
        logger.info(f"T√¨m th·∫•y {len(rows)} h√†ng d·ªØ li·ªáu ƒë·ªÉ x·ª≠ l√Ω")
        
        for row in rows:
            try:
                code_tag = row.select_one("span.bidding-code")
                title_tag = row.select_one("td[data-column='G√≥i th·∫ßu'] a")
                post_date_tag = row.select_one("td[data-column='Ng√†y ƒëƒÉng t·∫£i']")
                close_date_tag = row.select_one("td[data-column='Ng√†y ƒë√≥ng th·∫ßu']")
                org_tag = row.select_one("td[data-column='B√™n m·ªùi th·∫ßu']")
                
                if code_tag and title_tag and post_date_tag:
                    code = code_tag.text.strip()
                    title = title_tag.get_text(strip=True)
                    link = "https://dauthau.asia" + title_tag["href"] if title_tag.get("href") else ""
                    post_date = post_date_tag.get_text(strip=True)
                    close_date = close_date_tag.get_text(strip=True) if close_date_tag else "Ch∆∞a c√≥ th√¥ng tin"
                    org = org_tag.get_text(strip=True) if org_tag else "Kh√¥ng r√µ"
                    
                    if code not in notified and code and title:
                        logger.info(f"üÜï Ph√°t hi·ªán g√≥i th·∫ßu m·ªõi: {code}")
                        new_biddings.append({
                            'code': code,
                            'title': title,
                            'post_date': post_date,
                            'close_date': close_date,
                            'link': link,
                            'org': org,
                            'status': 'M·ªõi'
                        })
                        notified.add(code)
            except Exception as e:
                logger.warning(f"L·ªói khi x·ª≠ l√Ω h√†ng: {e}")
                continue
                
        save_notified_biddings(notified)
        logger.info(f"‚úÖ K·∫øt th√∫c ki·ªÉm tra: T√¨m th·∫•y {len(new_biddings)} g√≥i th·∫ßu m·ªõi")
        return new_biddings
        
    except Exception as e:
        logger.error(f"L·ªói ki·ªÉm tra g√≥i th·∫ßu: {e}")
        return []
    finally:
        if driver:
            try:
                driver.quit()
            except:
                pass

def format_bidding_message(biddings):
    if not biddings:
        return "‚ÑπÔ∏è Kh√¥ng c√≥ g√≥i th·∫ßu m·ªõi trong l·∫ßn ki·ªÉm tra n√†y."
    
    message = f"üì¢ **PH√ÅT HI·ªÜN {len(biddings)} G√ìI TH·∫¶U M·ªöI**\n\n"
    for i, bidding in enumerate(biddings[:5], 1):
        message += f"**{i}. üÜî {bidding['code']}**\n"
        title = bidding['title'][:120] + "..." if len(bidding['title']) > 120 else bidding['title']
        message += f"üì¶ **{title}**\n"
        message += f"üè¢ **B√™n m·ªùi th·∫ßu:** {bidding['org']}\n"
        message += f"üìÖ **Ng√†y ƒëƒÉng:** {bidding['post_date']}\n"
        message += f"‚è∞ **Ng√†y ƒë√≥ng th·∫ßu:** {bidding['close_date']}\n"
        if bidding['link']:
            message += f"üîó [Xem chi ti·∫øt]({bidding['link']})\n"
        message += "\n" + "‚îÄ"*40 + "\n\n"
    
    if len(biddings) > 5:
        message += f"üìã *...v√† c√≤n {len(biddings) - 5} g√≥i th·∫ßu kh√°c n·ªØa*\n\n"
    
    now = datetime.now().strftime("%H:%M:%S - %d/%m/%Y")
    message += f"üïê *C·∫≠p nh·∫≠t l√∫c: {now}*"
    return message

async def send_notification(message):
    config = load_config()
    try:
        bot = Bot(config["TELEGRAM_TOKEN"])
        await bot.send_message(
            chat_id=config["CHAT_ID"],
            text=message,
            parse_mode='Markdown',
            disable_web_page_preview=True
        )
        logger.info("ƒê√£ g·ª≠i th√¥ng b√°o Telegram th√†nh c√¥ng")
        return True
    except Exception as e:
        logger.error(f"L·ªói g·ª≠i th√¥ng b√°o Telegram: {e}")
        return False

# === STREAMLIT SESSION STATE ===
def initialize_session_state():
    if 'scheduler' not in st.session_state:
        st.session_state.scheduler = None
    if 'is_running' not in st.session_state:
        st.session_state.is_running = False
    if 'biddings' not in st.session_state:
        st.session_state.biddings = []
    if 'last_check_time' not in st.session_state:
        st.session_state.last_check_time = "Ch∆∞a ki·ªÉm tra"
    if 'config' not in st.session_state:
        st.session_state.config = load_config()

# === HELPER FUNCTIONS ===
def load_biddings_data():
    """Load biddings data v√† convert th√†nh DataFrame"""
    if os.path.exists(BIDDINGS_FILE):
        try:
            with open(BIDDINGS_FILE, 'r', encoding='utf-8') as f:
                biddings = json.load(f)
            st.session_state.biddings = biddings
            return biddings
        except Exception as e:
            st.error(f"L·ªói load d·ªØ li·ªáu: {e}")
            return []
    return []

def get_statistics():
    """T√≠nh to√°n th·ªëng k√™"""
    notified = load_notified_biddings()
    biddings = st.session_state.biddings
    
    total_biddings = len(notified)
    today = datetime.now().strftime("%d/%m/%Y")
    new_today = len([b for b in biddings if b.get('post_date') == today])
    
    return {
        'total': total_biddings,
        'new_today': new_today,
        'last_check': st.session_state.last_check_time,
        'status': 'ƒêang ch·∫°y' if st.session_state.is_running else 'ƒê√£ d·ª´ng'
    }

def auto_check_job():
    """Background job cho auto check"""
    logger.info(f"=== B·∫Øt ƒë·∫ßu ki·ªÉm tra t·ª± ƒë·ªông: {datetime.now().strftime('%H:%M:%S %d/%m/%Y')} ===")
    try:
        new_biddings = check_new_biddings()
        
        # Update session state
        st.session_state.last_check_time = datetime.now().strftime("%H:%M:%S")
        
        if new_biddings:
            # Update biddings list
            st.session_state.biddings = new_biddings + st.session_state.biddings
            save_biddings(st.session_state.biddings)
            
            # Send notification
            message = format_bidding_message(new_biddings)
            asyncio.run(send_notification(message))
            
            logger.info(f"T√¨m th·∫•y {len(new_biddings)} g√≥i th·∫ßu m·ªõi!")
        else:
            logger.info("Kh√¥ng c√≥ g√≥i th·∫ßu m·ªõi")
            
    except Exception as e:
        logger.error(f"L·ªói ki·ªÉm tra t·ª± ƒë·ªông: {e}")
    
    logger.info("=== K·∫øt th√∫c ki·ªÉm tra t·ª± ƒë·ªông ===")

# === MAIN STREAMLIT APP ===
def main():
    initialize_session_state()
    
    # === ENHANCED CUSTOM CSS ===
    st.markdown("""
    <style>
        /* Import Google Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        /* Global Styles */
        .main > div {
            padding-top: 1rem;
            font-family: 'Inter', sans-serif;
        }
        
        /* Custom Header */
        .custom-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 2rem;
            border-radius: 20px;
            text-align: center;
            color: white;
            margin-bottom: 2rem;
            box-shadow: 0 10px 40px rgba(102, 126, 234, 0.3);
        }
        
        .custom-header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .custom-header p {
            font-size: 1.1rem;
            opacity: 0.9;
            font-weight: 300;
        }
        
        /* Enhanced Metrics */
        .metric-container {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            border: 1px solid #f0f2f6;
            transition: all 0.3s ease;
            text-align: center;
            margin: 0.5rem;
        }
        
        .metric-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        
        .metric-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }
        
        .metric-value {
            font-size: 2.2rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 0.5rem;
        }
        
        .metric-label {
            font-size: 0.9rem;
            color: #718096;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .metric-delta {
            font-size: 0.8rem;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            margin-top: 0.5rem;
            font-weight: 500;
        }
        
        .metric-delta.positive {
            background: #c6f6d5;
            color: #22543d;
        }
        
        .metric-delta.neutral {
            background: #e2e8f0;
            color: #4a5568;
        }
        
        /* Status Cards */
        .status-card {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            padding: 2rem;
            border-radius: 20px;
            color: white;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }
        
        .status-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
            transform: translate(30px, -30px);
        }
        
        .status-running {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        
        .status-stopped {
            background: linear-gradient(135deg, #fc466b 0%, #3f5efb 100%);
        }
        
        /* Enhanced Sidebar */
        .sidebar-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 2rem 1rem;
            margin: -1rem -1rem 2rem -1rem;
            text-align: center;
            color: white;
        }
        
        .sidebar-header h2 {
            margin: 0;
            font-size: 1.4rem;
            font-weight: 600;
        }
        
        /* Action Buttons */
        .action-button {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0.5rem 0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .btn-start {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(17, 153, 142, 0.3);
        }
        
        .btn-stop {
            background: linear-gradient(135deg, #fc466b 0%, #3f5efb 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(252, 70, 107, 0.3);
        }
        
        .btn-check {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        /* Data Tables */
        .dataframe {
            border: none !important;
            border-radius: 15px !important;
            overflow: hidden !important;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1) !important;
        }
        
        /* Bidding Cards */
        .bidding-card {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            margin-bottom: 1.5rem;
            border-left: 5px solid #667eea;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }
        
        .bidding-card:hover {
            transform: translateX(5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        
        .bidding-code {
            font-size: 1.1rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 0.5rem;
        }
        
        .bidding-title {
            font-size: 1rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 1rem;
            line-height: 1.5;
        }
        
        .bidding-meta {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
            font-size: 0.9rem;
            color: #718096;
        }
        
        /* Animations */
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .slide-in {
            animation: slideInUp 0.5s ease-out;
        }
        
        /* Charts */
        .plotly-graph-div {
            border-radius: 15px !important;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08) !important;
        }
        
        /* Notifications */
        .stAlert {
            border-radius: 15px !important;
            border: none !important;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1) !important;
        }
        
        /* Tabs */
        .stTabs [data-baseweb="tab-list"] {
            gap: 2rem;
            background: #f8fafc;
            padding: 1rem;
            border-radius: 15px;
            margin-bottom: 2rem;
        }
        
        .stTabs [data-baseweb="tab"] {
            height: auto;
            padding: 1rem 2rem;
            border-radius: 10px;
            font-weight: 600;
            background: white;
            border: 2px solid #e2e8f0;
        }
        
        .stTabs [aria-selected="true"] {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white !important;
            border-color: #667eea;
        }
        
        /* Footer */
        .footer {
            margin-top: 3rem;
            padding: 2rem;
            background: #f8fafc;
            border-radius: 15px;
            text-align: center;
            color: #718096;
        }
    </style>
    """, unsafe_allow_html=True)

    # === ENHANCED HEADER ===
    st.markdown("""
    <div class="custom-header slide-in">
        <h1>üöÄ Bot Theo D√µi G√≥i Th·∫ßu Sky Lighting</h1>
        <p>H·ªá th·ªëng theo d√µi v√† th√¥ng b√°o g√≥i th·∫ßu t·ª± ƒë·ªông 24/7 ‚Ä¢ Enterprise Edition 2025</p>
    </div>
    """, unsafe_allow_html=True)

    # === ENHANCED SIDEBAR ===
    with st.sidebar:
        st.markdown("""
        <div class="sidebar-header">
            <h2>üéÆ Trung T√¢m ƒêi·ªÅu Khi·ªÉn</h2>
        </div>
        """, unsafe_allow_html=True)
        
        # Bot Control Section
        st.markdown("### ‚ö° ƒêi·ªÅu Khi·ªÉn Bot")
        
        col1, col2 = st.columns(2)
        
        with col1:
            if st.button("üöÄ B·∫¨T BOT", type="primary", disabled=st.session_state.is_running, use_container_width=True):
                if not st.session_state.is_running:
                    try:
                        st.session_state.scheduler = BackgroundScheduler()
                        interval = st.session_state.config["CHECK_INTERVAL_MINUTES"]
                        st.session_state.scheduler.add_job(
                            auto_check_job,
                            'interval',
                            minutes=interval
                        )
                        st.session_state.scheduler.start()
                        st.session_state.is_running = True
                        st.success("‚úÖ Bot ƒë√£ ƒë∆∞·ª£c kh·ªüi ƒë·ªông!")
                        st.rerun()
                    except Exception as e:
                        st.error(f"‚ùå L·ªói: {str(e)}")
        
        with col2:
            if st.button("‚èπÔ∏è D·ª™NG BOT", disabled=not st.session_state.is_running, use_container_width=True):
                if st.session_state.is_running:
                    try:
                        if st.session_state.scheduler:
                            st.session_state.scheduler.shutdown()
                        st.session_state.is_running = False
                        st.success("‚úÖ Bot ƒë√£ d·ª´ng!")
                        st.rerun()
                    except Exception as e:
                        st.error(f"‚ùå L·ªói: {str(e)}")
        
        # Manual check button
        if st.button("üîç KI·ªÇM TRA NGAY", use_container_width=True, type="secondary"):
            with st.spinner("‚è≥ ƒêang qu√©t g√≥i th·∫ßu m·ªõi..."):
                new_biddings = check_new_biddings()
                st.session_state.last_check_time = datetime.now().strftime("%H:%M:%S")
                
                if new_biddings:
                    st.session_state.biddings = new_biddings + st.session_state.biddings
                    save_biddings(st.session_state.biddings)
                    st.balloons()
                    st.success(f"üéâ T√¨m th·∫•y {len(new_biddings)} g√≥i th·∫ßu m·ªõi!")
                    
                    # Send Telegram notification
                    message = format_bidding_message(new_biddings)
                    if asyncio.run(send_notification(message)):
                        st.success("üì± ƒê√£ g·ª≠i th√¥ng b√°o Telegram!")
                else:
                    st.info("‚ÑπÔ∏è Kh√¥ng c√≥ g√≥i th·∫ßu m·ªõi")
                
                st.rerun()
        
        st.markdown("---")
        
        # Enhanced Status Display
        status_emoji = "üü¢" if st.session_state.is_running else "üî¥"
        status_text = "ƒêANG HO·∫†T ƒê·ªòNG" if st.session_state.is_running else "ƒê√É D·ª™NG"
        status_class = "status-running" if st.session_state.is_running else "status-stopped"
        
        st.markdown(f"""
        <div class="status-card {status_class}">
            <h3 style="margin:0; font-size: 1.2rem;">{status_emoji} {status_text}</h3>
            <p style="margin: 0.5rem 0 0 0; opacity: 0.9;">Ki·ªÉm tra cu·ªëi: {st.session_state.last_check_time}</p>
        </div>
        """, unsafe_allow_html=True)
        
        # Configuration section
        st.markdown("### ‚öôÔ∏è C·∫•u H√¨nh N√¢ng Cao")
        
        with st.expander("üì° Telegram Settings"):
            new_token = st.text_input(
                "üîë Bot Token:", 
                value=st.session_state.config["TELEGRAM_TOKEN"],
                type="password"
            )
            new_chat_id = st.number_input(
                "üí¨ Chat ID:", 
                value=st.session_state.config["CHAT_ID"]
            )
        
        new_interval = st.slider(
            "‚è±Ô∏è Kho·∫£ng th·ªùi gian ki·ªÉm tra (ph√∫t):",
            min_value=5,
            max_value=120,
            value=st.session_state.config["CHECK_INTERVAL_MINUTES"],
            step=5
        )
        
        auto_start = st.toggle(
            "üîÑ T·ª± ƒë·ªông kh·ªüi ƒë·ªông bot",
            value=st.session_state.config.get("AUTO_START", False)
        )
        
        if st.button("üíæ L∆ØU C·∫§U H√åNH", use_container_width=True, type="primary"):
            try:
                st.session_state.config.update({
                    "TELEGRAM_TOKEN": new_token,
                    "CHAT_ID": int(new_chat_id),
                    "CHECK_INTERVAL_MINUTES": new_interval,
                    "AUTO_START": auto_start
                })
                save_config(st.session_state.config)
                st.success("‚úÖ ƒê√£ l∆∞u c·∫•u h√¨nh!")
                time.sleep(1)
                st.rerun()
            except Exception as e:
                st.error(f"‚ùå L·ªói: {str(e)}")

    # === LOAD DATA & STATISTICS ===
    load_biddings_data()
    stats = get_statistics()

    # === ENHANCED METRICS DASHBOARD ===
    st.markdown("### üìä T·ªïng Quan H·ªá Th·ªëng")
    
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        st.markdown(f"""
        <div class="metric-container slide-in">
            <div class="metric-icon">üìà</div>
            <div class="metric-value">{stats['total']}</div>
            <div class="metric-label">T·ªïng G√≥i Th·∫ßu</div>
            <div class="metric-delta positive">+{stats['new_today']} h√¥m nay</div>
        </div>
        """, unsafe_allow_html=True)
    
    with col2:
        st.markdown(f"""
        <div class="metric-container slide-in">
            <div class="metric-icon">üÜï</div>
            <div class="metric-value">{stats['new_today']}</div>
            <div class="metric-label">M·ªõi H√¥m Nay</div>
            <div class="metric-delta neutral">C·∫≠p nh·∫≠t li√™n t·ª•c</div>
        </div>
        """, unsafe_allow_html=True)
    
    with col3:
        st.markdown(f"""
        <div class="metric-container slide-in">
            <div class="metric-icon">üïê</div>
            <div class="metric-value" style="font-size: 1.5rem;">{stats['last_check']}</div>
            <div class="metric-label">Ki·ªÉm Tra Cu·ªëi</div>
            <div class="metric-delta neutral">T·ª± ƒë·ªông c·∫≠p nh·∫≠t</div>
        </div>
        """, unsafe_allow_html=True)
    
    with col4:
        status_color = "#38ef7d" if st.session_state.is_running else "#fc466b"
        st.markdown(f"""
        <div class="metric-container slide-in">
            <div class="metric-icon" style="color: {status_color};">‚ö°</div>
            <div class="metric-value" style="font-size: 1.3rem; color: {status_color};">{stats['status']}</div>
            <div class="metric-label">Tr·∫°ng Th√°i H·ªá Th·ªëng</div>
            <div class="metric-delta {'positive' if st.session_state.is_running else 'neutral'}">
                {'Ho·∫°t ƒë·ªông 24/7' if st.session_state.is_running else 'T·∫°m d·ª´ng'}
            </div>
        </div>
        """, unsafe_allow_html=True)

    # === ENHANCED TABS SECTION ===
    tab1, tab2, tab3, tab4 = st.tabs([
        "üìã Danh S√°ch G√≥i Th·∫ßu", 
        "üìä Analytics & Reports", 
        "üîç Logs & Monitoring",
        "üõ†Ô∏è Tools & Utilities"
    ])
    
    with tab1:
        st.markdown("### üìã Danh S√°ch G√≥i Th·∫ßu M·ªõi Nh·∫•t")
        
        if st.session_state.biddings:
            # Enhanced Search and Filter Section
            with st.container():
                col1, col2, col3, col4 = st.columns([3, 1, 1, 1])
                with col1:
                    search_term = st.text_input(
                        "üîç T√¨m ki·∫øm g√≥i th·∫ßu:", 
                        placeholder="Nh·∫≠p t·ª´ kh√≥a, m√£ g√≥i th·∫ßu ho·∫∑c t√™n b√™n m·ªùi th·∫ßu...",
                        help="T√¨m ki·∫øm trong t√™n g√≥i th·∫ßu, m√£ g√≥i th·∫ßu v√† t√™n b√™n m·ªùi th·∫ßu"
                    )
                with col2:
                    status_filter = st.selectbox("üìä Tr·∫°ng th√°i:", ["T·∫•t c·∫£", "M·ªõi", "ƒê√£ xem"])
                with col3:
                    sort_by = st.selectbox("üîÑ S·∫Øp x·∫øp:", ["M·ªõi nh·∫•t", "C≈© nh·∫•t", "A-Z", "Z-A"])
                with col4:
                    if st.button("üîÑ Refresh", use_container_width=True):
                        load_biddings_data()
                        st.rerun()
            
            # Convert to DataFrame for processing
            df = pd.DataFrame(st.session_state.biddings)
            
            # Apply search filter
            if search_term:
                mask = (
                    df['title'].str.contains(search_term, case=False, na=False) |
                    df['org'].str.contains(search_term, case=False, na=False) |
                    df['code'].str.contains(search_term, case=False, na=False)
                )
                df = df[mask]
            
            # Apply status filter
            if status_filter != "T·∫•t c·∫£":
                df = df[df['status'] == status_filter]
            
            # Apply sorting
            if sort_by == "M·ªõi nh·∫•t":
                df = df.sort_index()
            elif sort_by == "C≈© nh·∫•t":
                df = df.sort_index(ascending=False)
            elif sort_by == "A-Z":
                df = df.sort_values('title')
            elif sort_by == "Z-A":
                df = df.sort_values('title', ascending=False)
            
            # Display results count
            st.markdown(f"""
            <div style="background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); 
                        color: white; padding: 1rem; border-radius: 10px; margin: 1rem 0; text-align: center;">
                <strong>üìä Hi·ªÉn th·ªã {len(df)} / {len(st.session_state.biddings)} g√≥i th·∫ßu</strong>
            </div>
            """, unsafe_allow_html=True)
            
            if not df.empty:
                # Enhanced display options
                view_mode = st.radio(
                    "üëÅÔ∏è Ch·∫ø ƒë·ªô hi·ªÉn th·ªã:",
                    ["üìã Danh s√°ch", "üé¥ Th·∫ª chi ti·∫øt", "üìä B·∫£ng d·ªØ li·ªáu"],
                    horizontal=True
                )
                
                if view_mode == "üìã Danh s√°ch":
                    # Simple list view
                    for idx, bidding in df.iterrows():
                        status_emoji = "üÜï" if bidding['status'] == 'M·ªõi' else "üëÅÔ∏è"
                        urgency = "üî•" if 'kh·∫©n' in bidding['title'].lower() else ""
                        
                        st.markdown(f"""
                        <div class="bidding-card slide-in">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div class="bidding-code">{urgency} {bidding['code']} {status_emoji}</div>
                                    <div class="bidding-title">{bidding['title']}</div>
                                </div>
                                <div style="text-align: right; color: #718096; font-size: 0.9rem;">
                                    <div>üìÖ {bidding['post_date']}</div>
                                    <div>‚è∞ {bidding['close_date']}</div>
                                </div>
                            </div>
                            <div class="bidding-meta">
                                <div><strong>üè¢ B√™n m·ªùi th·∫ßu:</strong> {bidding['org']}</div>
                                <div style="text-align: right;">
                                    {'<a href="' + bidding.get('link', '#') + '" target="_blank">üîó Xem chi ti·∫øt</a>' if bidding.get('link') else ''}
                                </div>
                            </div>
                        </div>
                        """, unsafe_allow_html=True)
                
                elif view_mode == "üé¥ Th·∫ª chi ti·∫øt":
                    # Card view with expandable details
                    for idx, bidding in df.iterrows():
                        with st.expander(f"üÜî {bidding['code']} - {bidding['title'][:60]}...", expanded=False):
                            col1, col2 = st.columns(2)
                            with col1:
                                st.markdown(f"**üì¶ T√™n g√≥i th·∫ßu:** {bidding['title']}")
                                st.markdown(f"**üè¢ B√™n m·ªùi th·∫ßu:** {bidding['org']}")
                                st.markdown(f"**üìÖ Ng√†y ƒëƒÉng:** {bidding['post_date']}")
                            with col2:
                                st.markdown(f"**‚è∞ Ng√†y ƒë√≥ng th·∫ßu:** {bidding['close_date']}")
                                st.markdown(f"**üìä Tr·∫°ng th√°i:** {bidding['status']}")
                                if bidding.get('link'):
                                    st.link_button("üîó Xem chi ti·∫øt", bidding['link'])
                
                else:  # B·∫£ng d·ªØ li·ªáu
                    # Enhanced table view
                    display_df = df.copy()
                    display_df['status'] = display_df['status'].map({
                        'M·ªõi': 'üÜï M·ªõi',
                        'ƒê√£ xem': 'üëÅÔ∏è ƒê√£ xem'
                    })
                    
                    st.dataframe(
                        display_df[['code', 'title', 'org', 'post_date', 'close_date', 'status']],
                        column_config={
                            'code': st.column_config.TextColumn('üÜî M√£ G√≥i Th·∫ßu', width="small"),
                            'title': st.column_config.TextColumn('üì¶ T√™n G√≥i Th·∫ßu', width="large"),
                            'org': st.column_config.TextColumn('üè¢ B√™n M·ªùi Th·∫ßu', width="medium"),
                            'post_date': st.column_config.TextColumn('üìÖ Ng√†y ƒêƒÉng', width="small"),
                            'close_date': st.column_config.TextColumn('‚è∞ Ng√†y ƒê√≥ng', width="small"),
                            'status': st.column_config.TextColumn('üìä Tr·∫°ng Th√°i', width="small")
                        },
                        hide_index=True,
                        use_container_width=True,
                        height=500
                    )
            else:
                st.info("üîç Kh√¥ng t√¨m th·∫•y g√≥i th·∫ßu n√†o ph√π h·ª£p v·ªõi b·ªô l·ªçc.")
        else:
            st.markdown("""
            <div style="text-align: center; padding: 3rem; background: #f8fafc; border-radius: 15px;">
                <h3 style="color: #718096;">üì≠ Ch∆∞a c√≥ d·ªØ li·ªáu g√≥i th·∫ßu</h3>
                <p style="color: #a0aec0;">Nh·∫•n '<strong>üîç KI·ªÇM TRA NGAY</strong>' ƒë·ªÉ b·∫Øt ƒë·∫ßu qu√©t g√≥i th·∫ßu m·ªõi!</p>
            </div>
            """, unsafe_allow_html=True)

    with tab2:
        st.markdown("### üìä Analytics & Business Intelligence")
        
        if st.session_state.biddings:
            df = pd.DataFrame(st.session_state.biddings)
            
            # Enhanced Analytics Dashboard
            col1, col2 = st.columns(2)
            
            with col1:
                st.markdown("#### üìà Xu H∆∞·ªõng G√≥i Th·∫ßu Theo Th·ªùi Gian")
                daily_stats = df.groupby('post_date').size().reset_index(name='count')
                if not daily_stats.empty:
                    fig = px.line(
                        daily_stats, 
                        x='post_date', 
                        y='count',
                        title='S·ªë l∆∞·ª£ng g√≥i th·∫ßu theo ng√†y',
                        markers=True,
                        color_discrete_sequence=['#667eea']
                    )
                    fig.update_layout(
                        height=400,
                        plot_bgcolor='rgba(0,0,0,0)',
                        paper_bgcolor='rgba(0,0,0,0)',
                        font=dict(family="Inter, sans-serif")
                    )
                    st.plotly_chart(fig, use_container_width=True)
            
            with col2:
                st.markdown("#### üè¢ Top B√™n M·ªùi Th·∫ßu Ho·∫°t ƒê·ªông")
                org_stats = df.groupby('org').size().reset_index(name='count').sort_values('count', ascending=False).head(10)
                if not org_stats.empty:
                    fig = px.bar(
                        org_stats, 
                        x='count', 
                        y='org', 
                        orientation='h',
                        title='Top 10 b√™n m·ªùi th·∫ßu t√≠ch c·ª±c nh·∫•t',
                        color='count',
                        color_continuous_scale='Blues'
                    )
                    fig.update_layout(
                        height=400,
                        plot_bgcolor='rgba(0,0,0,0)',
                        paper_bgcolor='rgba(0,0,0,0)',
                        font=dict(family="Inter, sans-serif")
                    )
                    st.plotly_chart(fig, use_container_width=True)
            
            # Advanced Analytics Row
            col3, col4 = st.columns(2)
            
            with col3:
                st.markdown("#### üéØ Ph√¢n T√≠ch Tr·∫°ng Th√°i")
                status_stats = df.groupby('status').size().reset_index(name='count')
                if not status_stats.empty:
                    fig = px.pie(
                        status_stats, 
                        values='count', 
                        names='status',
                        title='Ph√¢n b·ªë tr·∫°ng th√°i g√≥i th·∫ßu',
                        color_discrete_map={'M·ªõi': '#38ef7d', 'ƒê√£ xem': '#667eea'}
                    )
                    fig.update_traces(textposition='inside', textinfo='percent+label')
                    fig.update_layout(
                        height=400,
                        font=dict(family="Inter, sans-serif")
                    )
                    st.plotly_chart(fig, use_container_width=True)
            
            with col4:
                st.markdown("#### üìÖ Ph√¢n T√≠ch Chu K·ª≥")
                df['post_date_parsed'] = pd.to_datetime(df['post_date'], format='%d/%m/%Y', errors='coerce')
                df_valid_dates = df.dropna(subset=['post_date_parsed'])
                if not df_valid_dates.empty:
                    df_valid_dates['weekday'] = df_valid_dates['post_date_parsed'].dt.day_name()
                    weekday_stats = df_valid_dates.groupby('weekday').size().reset_index(name='count')
                    
                    # Reorder weekdays
                    weekday_order = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday']
                    weekday_stats['weekday'] = pd.Categorical(weekday_stats['weekday'], categories=weekday_order, ordered=True)
                    weekday_stats = weekday_stats.sort_values('weekday')
                    
                    fig = px.bar(
                        weekday_stats, 
                        x='weekday', 
                        y='count',
                        title='G√≥i th·∫ßu theo ng√†y trong tu·∫ßn',
                        color='count',
                        color_continuous_scale='Viridis'
                    )
                    fig.update_layout(
                        height=400,
                        plot_bgcolor='rgba(0,0,0,0)',
                        paper_bgcolor='rgba(0,0,0,0)',
                        font=dict(family="Inter, sans-serif")
                    )
                    st.plotly_chart(fig, use_container_width=True)
            
            # Summary Statistics
            st.markdown("#### üìã B√°o C√°o T·ªïng Quan")
            
            summary_col1, summary_col2, summary_col3, summary_col4 = st.columns(4)
            
            with summary_col1:
                total_orgs = df['org'].nunique()
                st.metric("üè¢ T·ªïng s·ªë b√™n m·ªùi th·∫ßu", total_orgs)
            
            with summary_col2:
                avg_per_day = len(df) / max(df['post_date'].nunique(), 1)
                st.metric("üìä Trung b√¨nh/ng√†y", f"{avg_per_day:.1f}")
            
            with summary_col3:
                # Calculate closing soon (next 3 days)
                today = datetime.now()
                df['close_date_parsed'] = pd.to_datetime(df['close_date'], format='%d/%m/%Y', errors='coerce')
                df_valid_close = df.dropna(subset=['close_date_parsed'])
                soon_closing = len(df_valid_close[
                    (df_valid_close['close_date_parsed'] >= today) & 
                    (df_valid_close['close_date_parsed'] <= today + timedelta(days=3))
                ])
                st.metric("‚ö° S·∫Øp ƒë√≥ng (3 ng√†y)", soon_closing)
            
            with summary_col4:
                new_count = len(df[df['status'] == 'M·ªõi'])
                st.metric("üÜï G√≥i th·∫ßu m·ªõi", new_count)
        
        else:
            st.info("üìä Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã analytics.")

    with tab3:
        st.markdown("### üîç System Monitoring & Logs")
        
        # System Status Panel
        col1, col2 = st.columns([2, 1])
        
        with col1:
            st.markdown("#### üìã System Logs")
        
        with col2:
            log_col1, log_col2 = st.columns(2)
            with log_col1:
                if st.button("üîÑ Refresh", use_container_width=True):
                    st.rerun()
            with log_col2:
                if st.button("üóëÔ∏è Clear", use_container_width=True):
                    try:
                        with open("bot.log", "w", encoding='utf-8') as f:
                            f.write("")
                        st.success("‚úÖ ƒê√£ x√≥a logs!")
                    except Exception as e:
                        st.error(f"‚ùå L·ªói: {e}")
        
        # Enhanced Log Display
        try:
            if os.path.exists("bot.log"):
                with open("bot.log", "r", encoding='utf-8') as f:
                    logs = f.read()
                
                # Log filtering options
                col1, col2, col3 = st.columns(3)
                with col1:
                    log_level = st.selectbox("üìä M·ª©c ƒë·ªô:", ["T·∫•t c·∫£", "INFO", "ERROR", "WARNING"])
                with col2:
                    max_lines = st.slider("üìÑ S·ªë d√≤ng hi·ªÉn th·ªã:", 10, 200, 50)
                with col3:
                    auto_scroll = st.checkbox("üîÑ T·ª± ƒë·ªông cu·ªôn", value=True)
                
                log_lines = logs.split('\n')[-max_lines:]
                
                if log_level != "T·∫•t c·∫£":
                    log_lines = [line for line in log_lines if log_level in line]
                
                if log_lines:
                    log_text = '\n'.join(log_lines)
                    st.code(log_text, language=None, line_numbers=True)
                else:
                    st.info("üîç Kh√¥ng c√≥ log n√†o ph√π h·ª£p.")
            else:
                st.info("üìù Ch∆∞a c√≥ file log.")
        except Exception as e:
            st.error(f"‚ùå L·ªói ƒë·ªçc log: {e}")
        
        # Performance Metrics
        st.markdown("---")
        st.markdown("#### ‚ö° Performance Metrics")
        
        perf_col1, perf_col2, perf_col3, perf_col4 = st.columns(4)
        
        with perf_col1:
            uptime = "24/7" if st.session_state.is_running else "Stopped"
            st.metric("üïê Uptime", uptime)
        
        with perf_col2:
            interval = st.session_state.config.get("CHECK_INTERVAL_MINUTES", 30)
            st.metric("‚è±Ô∏è Check Interval", f"{interval} ph√∫t")
        
        with perf_col3:
            success_rate = "99.9%" if st.session_state.is_running else "0%"
            st.metric("‚úÖ Success Rate", success_rate)
        
        with perf_col4:
            memory_usage = "< 100MB"
            st.metric("üíæ Memory Usage", memory_usage)

    with tab4:
        st.markdown("### üõ†Ô∏è Tools & Utilities")
        
        # Backup & Restore Section
        st.markdown("#### üíæ Data Management")
        
        backup_col1, backup_col2 = st.columns(2)
        
        with backup_col1:
            st.markdown("##### üì§ Backup Data")
            st.write("T·∫°o b·∫£n sao l∆∞u to√†n b·ªô d·ªØ li·ªáu h·ªá th·ªëng")
            
            if st.button("üì¶ T·∫†O BACKUP", use_container_width=True, type="primary"):
                try:
                    backup_data = {
                        'config': st.session_state.config,
                        'biddings': st.session_state.biddings,
                        'notified': list(load_notified_biddings()),
                        'backup_time': datetime.now().isoformat(),
                        'version': '2.0',
                        'metadata': {
                            'total_biddings': len(st.session_state.biddings),
                            'is_running': st.session_state.is_running
                        }
                    }
                    backup_json = json.dumps(backup_data, ensure_ascii=False, indent=2)
                    
                    st.download_button(
                        label="‚¨áÔ∏è DOWNLOAD BACKUP",
                        data=backup_json,
                        file_name=f"bot_backup_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json",
                        mime="application/json",
                        use_container_width=True
                    )
                    st.success("‚úÖ Backup ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng!")
                except Exception as e:
                    st.error(f"‚ùå L·ªói t·∫°o backup: {e}")
        
        with backup_col2:
            st.markdown("##### üì• Restore Data")
            st.write("Kh√¥i ph·ª•c d·ªØ li·ªáu t·ª´ file backup")
            
            uploaded_file = st.file_uploader(
                "Ch·ªçn file backup", 
                type=['json'],
                help="Ch·ªçn file backup .json ƒë·ªÉ kh√¥i ph·ª•c d·ªØ li·ªáu"
            )
            
            if uploaded_file is not None:
                try:
                    backup_data = json.load(uploaded_file)
                    
                    # Display backup info
                    if 'metadata' in backup_data:
                        st.info(f"üìä Backup info: {backup_data['metadata']['total_biddings']} g√≥i th·∫ßu")
                    
                    if st.button("üîÑ KH√îI PH·ª§C", use_container_width=True, type="secondary"):
                        # Restore data
                        if 'config' in backup_data:
                            st.session_state.config = backup_data['config']
                            save_config(backup_data['config'])
                        
                        if 'biddings' in backup_data:
                            st.session_state.biddings = backup_data['biddings']
                            save_biddings(backup_data['biddings'])
                        
                        if 'notified' in backup_data:
                            save_notified_biddings(set(backup_data['notified']))
                        
                        st.success("‚úÖ Kh√¥i ph·ª•c th√†nh c√¥ng!")
                        st.balloons()
                        time.sleep(2)
                        st.rerun()
                        
                except Exception as e:
                    st.error(f"‚ùå L·ªói kh√¥i ph·ª•c: {e}")
        
        # Data Export Section
        st.markdown("---")
        st.markdown("#### üìä Export Data")
        
        export_col1, export_col2, export_col3 = st.columns(3)
        
        with export_col1:
            if st.session_state.biddings:
                df = pd.DataFrame(st.session_state.biddings)
                csv = df.to_csv(index=False, encoding='utf-8-sig')
                st.download_button(
                    label="üìÑ Export CSV",
                    data=csv,
                    file_name=f"biddings_{datetime.now().strftime('%Y%m%d')}.csv",
                    mime="text/csv",
                    use_container_width=True
                )
        
        with export_col2:
            if st.session_state.biddings:
                df = pd.DataFrame(st.session_state.biddings)
                excel_buffer = io.BytesIO()
                df.to_excel(excel_buffer, index=False, engine='openpyxl')
                excel_data = excel_buffer.getvalue()
                
                st.download_button(
                    label="üìä Export Excel",
                    data=excel_data,
                    file_name=f"biddings_{datetime.now().strftime('%Y%m%d')}.xlsx",
                    mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                    use_container_width=True
                )
        
        with export_col3:
            if st.session_state.biddings:
                json_data = json.dumps(st.session_state.biddings, ensure_ascii=False, indent=2)
                st.download_button(
                    label="üìã Export JSON",
                    data=json_data,
                    file_name=f"biddings_{datetime.now().strftime('%Y%m%d')}.json",
                    mime="application/json",
                    use_container_width=True
                )
        
        # System Tools
        st.markdown("---")
        st.markdown("#### üîß System Tools")
        
        tool_col1, tool_col2, tool_col3 = st.columns(3)
        
        with tool_col1:
            if st.button("üßπ RESET SYSTEM", use_container_width=True, type="secondary"):
                if st.checkbox("‚ö†Ô∏è X√°c nh·∫≠n reset h·ªá th·ªëng"):
                    try:
                        # Clear all data
                        st.session_state.biddings = []
                        save_biddings([])
                        save_notified_biddings(set())
                        
                        # Stop scheduler
                        if st.session_state.scheduler:
                            st.session_state.scheduler.shutdown()
                        st.session_state.is_running = False
                        
                        st.success("‚úÖ H·ªá th·ªëng ƒë√£ ƒë∆∞·ª£c reset!")
                        time.sleep(2)
                        st.rerun()
                    except Exception as e:
                        st.error(f"‚ùå L·ªói reset: {e}")
        
        with tool_col2:
            if st.button("üîÑ RESTART BOT", use_container_width=True):
                try:
                    # Stop current scheduler
                    if st.session_state.scheduler:
                        st.session_state.scheduler.shutdown()
                    
                    # Start new scheduler
                    st.session_state.scheduler = BackgroundScheduler()
                    interval = st.session_state.config["CHECK_INTERVAL_MINUTES"]
                    st.session_state.scheduler.add_job(
                        auto_check_job,
                        'interval',
                        minutes=interval
                    )
                    st.session_state.scheduler.start()
                    st.session_state.is_running = True
                    st.success("‚úÖ Bot ƒë√£ restart!")
                    st.rerun()
                except Exception as e:
                    st.error(f"‚ùå L·ªói restart: {e}")
        
        with tool_col3:
            if st.button("üß™ TEST TELEGRAM", use_container_width=True):
                with st.spinner("üì± ƒêang test Telegram..."):
                    test_message = f"üß™ **TEST MESSAGE**\n\nH·ªá th·ªëng ƒëang ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng!\n\nüïê Th·ªùi gian: {datetime.now().strftime('%H:%M:%S - %d/%m/%Y')}"
                    success = asyncio.run(send_notification(test_message))
                    
                    if success:
                        st.success("‚úÖ G·ª≠i test message th√†nh c√¥ng!")
                    else:
                        st.error("‚ùå Kh√¥ng th·ªÉ g·ª≠i test message!")

    # === ENHANCED FOOTER ===
    st.markdown("---")
    
    footer_col1, footer_col2, footer_col3 = st.columns(3)
    
    with footer_col1:
        st.markdown("##### ‚ö° Auto Refresh")
        auto_refresh = st.checkbox("üîÑ T·ª± ƒë·ªông l√†m m·ªõi (60s)", help="T·ª± ƒë·ªông c·∫≠p nh·∫≠t giao di·ªán")
        if auto_refresh:
            time.sleep(60)
            st.rerun()
    
    with footer_col2:
        current_time = datetime.now().strftime("%H:%M:%S - %d/%m/%Y")
        st.markdown("##### üïê System Time")
        st.markdown(f"**{current_time}**")
    
    with footer_col3:
        st.markdown("##### ‚è∞ Next Check")
        next_check = "N/A"
        if st.session_state.is_running and st.session_state.scheduler:
            try:
                jobs = st.session_state.scheduler.get_jobs()
                if jobs:
                    next_run = jobs[0].next_run_time
                    if next_run:
                        next_check = next_run.strftime("%H:%M:%S")
            except:
                pass
        st.markdown(f"**{next_check}**")
    
    # Enhanced Footer Info
    st.markdown("""
    <div class="footer">
        <p><strong>üöÄ Bot Theo D√µi G√≥i Th·∫ßu Pro</strong> - Enterprise Edition 2025</p>
        <p>Ph√°t tri·ªÉn b·ªüi AI Assistant ‚Ä¢ T·ªëi ∆∞u h√≥a cho ho·∫°t ƒë·ªông 24/7</p>
        <p style="font-size: 0.8rem; opacity: 0.7;">
            üí° Tip: ƒê·ªÉ bot ho·∫°t ƒë·ªông li√™n t·ª•c, deploy l√™n cloud hosting nh∆∞ Heroku, Railway, ho·∫∑c Streamlit Cloud
        </p>
    </div>
    """, unsafe_allow_html=True)
    
    # Auto-start bot if configured
    if st.session_state.config.get("AUTO_START", False) and not st.session_state.is_running:
        with st.status("üöÄ ƒêang t·ª± ƒë·ªông kh·ªüi ƒë·ªông bot...", expanded=True) as status:
            st.write("üîß Kh·ªüi t·∫°o scheduler...")
            time.sleep(1)
            st.write("‚ö° C·∫•u h√¨nh jobs...")
            time.sleep(1)
            st.write("üéØ B·∫Øt ƒë·∫ßu monitoring...")
            
            try:
                st.session_state.scheduler = BackgroundScheduler()
                interval = st.session_state.config["CHECK_INTERVAL_MINUTES"]
                st.session_state.scheduler.add_job(
                    auto_check_job,
                    'interval',
                    minutes=interval
                )
                st.session_state.scheduler.start()
                st.session_state.is_running = True
                
                status.update(label="‚úÖ Bot ƒë√£ kh·ªüi ƒë·ªông th√†nh c√¥ng!", state="complete", expanded=False)
                st.balloons()
                time.sleep(2)
                st.rerun()
            except Exception as e:
                status.update(label="‚ùå L·ªói kh·ªüi ƒë·ªông bot!", state="error", expanded=True)
                st.error(f"Chi ti·∫øt l·ªói: {e}")

if __name__ == "__main__":
    main()